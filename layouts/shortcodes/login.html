<main class="mt-8 mb-20 lg:mt-12">
  <div class="max-w-5xl px-6 py-10 mx-auto">
    <header class="mb-10 text-center md:mb-12">
      <h1 class="mt-6 mb-6 text-4xl font-medium leading-tight md:text-5xl">Log In &amp;<br/><strong class="text-bold">Get Watching</strong></h1>
    </header>

    <form
      id="loginForm"
      class="max-w-md px-8 pt-8 pb-12 mx-auto">

      <div class="mb-8">
        <label for="join-email" class="label">Email Address</label>
        <input
          type="email"
          id="join-email"
          class="w-full field"
          required>
      </div>

      <div class="mb-8">
        <label for="join-password" class="label">Password</label>
        <input
          type="password"
          name="join-password"
          id="join-password"
          class="w-full field"
          required>
      </div>

      <div class="flex justify-end mb-10">
        <button class="order-2 button">Log In</button>
        <button class="order-1 inline-block px-8 py-2 font-bold text-red link" onclick="window.history.back()">Cancel</button>
      </div>

      <p class="text-sm text-right">Need an account? <a href="/join/" class="font-bold link">Join CFE.dev instead</a>.</p>
    </form>
  </div>
</main>

<script>
function handleLogin(email,password) {
  const auth = new GoTrue({
    APIUrl: 'https://cfe.dev/.netlify/identity',
    audience: '',
    setCookie: false,
  });
  auth
  .login(email, password)
  .then(response => {
    if (document.referrer && ((document.referrer.includes('cfe.dev') && !(document.referrer.includes('login'))) || document.referrer.includes('localhost:8888'))) {
      window.location.assign(document.referrer);
    }
    else {
      window.location.assign('/');
    }
  })
  .catch(error => console.log(JSON.stringify(error)));
}

document.getElementById("loginForm").addEventListener('submit',(e) =>{
  e.preventDefault();

  let form = e.currentTarget;
  let email = form.elements['join-email'].value;
  let password = form.elements['join-password'].value;
  console.log(document.referrer)

  handleLogin(email,password);
});
</script>
